<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>App.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">XXLChess</a> &gt; <a href="index.source.html" class="el_package">XXLChess</a> &gt; <span class="el_source">App.java</span></div><h1>App.java</h1><pre class="source lang-java linenums">package XXLChess;

import XXLChess.Game.GameStatus;
import XXLChess.GameReport.EndReason;
import java.io.*;
import java.net.URL;
import java.util.*;
import processing.core.*;
import processing.data.JSONObject;
import processing.event.MouseEvent;

/**
 * This is the main application class.
 * It acts as a renderer for the Game structure.
 */
public class App extends PApplet {

  /**
   * Constant declarations
   */
  public static final int SIDEBAR = 120;
  public static final int FPS = 60;
<span class="fc" id="L23">  public static int WIDTH = Tile.CELLSIZE * Board.BOARD_WIDTH + SIDEBAR;</span>
<span class="fc" id="L24">  public static int HEIGHT = Board.BOARD_WIDTH * Tile.CELLSIZE;</span>
  public static String configPath;

  // The configuration object
  private JSONObject conf;
  private Game game;

<span class="fc" id="L31">  private String errorMessage = null;</span>

    /**
   * Creates a new App with the default configuration file.
   */
<span class="fc" id="L36">  public App() {</span>
<span class="fc" id="L37">    configPath = &quot;config.json&quot;;</span>
<span class="fc" id="L38">    SoundPlayer.preloadSoundEffect(&quot;bruh.wav&quot;);</span>
<span class="fc" id="L39">    SoundPlayer.preloadSoundEffect(&quot;capture.wav&quot;);</span>
<span class="fc" id="L40">    SoundPlayer.preloadSoundEffect(&quot;castle.wav&quot;);</span>
<span class="fc" id="L41">    SoundPlayer.preloadSoundEffect(&quot;move-check.wav&quot;);</span>
<span class="fc" id="L42">    SoundPlayer.preloadSoundEffect(&quot;move-self.wav&quot;);</span>
<span class="fc" id="L43">    SoundPlayer.preloadSoundEffect(&quot;promote.wav&quot;);</span>
<span class="fc" id="L44">    SoundPlayer.preloadSoundEffect(&quot;win.wav&quot;);</span>
<span class="fc" id="L45">    SoundPlayer.preloadSoundEffect(&quot;lose.wav&quot;);</span>
<span class="fc" id="L46">  }</span>
  // Logic part (unit-testable)

  /**
   * Retrieves the target tiles for the currently selected tile.
   *
   * @return the set of target tiles.
   */
  public Set&lt;Tile&gt; getTargetTiles() {
    Set&lt;Tile&gt; targetTiles;
<span class="fc" id="L56">    Tile sel = game.getHumanAgent().getSelection();</span>
<span class="pc bpc" id="L57" title="1 of 2 branches missed.">    if (sel != null) {</span>
<span class="fc" id="L58">      Set&lt;Movement&gt; safeMovements = game.getSafeMovements(</span>
<span class="fc" id="L59">        game.getAllLegalMovements(game.getHumanAgent())</span>
      );
<span class="fc" id="L61">      targetTiles = new HashSet&lt;&gt;();</span>
<span class="fc bfc" id="L62" title="All 2 branches covered.">      for (Movement move : safeMovements) {</span>
<span class="fc bfc" id="L63" title="All 2 branches covered.">        if (move.getSourceTile() == sel) targetTiles.add(move.getTargetTile());</span>
<span class="fc" id="L64">      }</span>
<span class="fc" id="L65">    } else {</span>
<span class="nc" id="L66">      targetTiles = null;</span>
    }
<span class="fc" id="L68">    return targetTiles;</span>
  }

  /**
   * Loads the XXLChess game with the specified configuration file.
   *
   * @param configPath the path of the configuration file.
   * @throws Exception if an error occurs during loading.
   */
  public void loadXXLChess(String configPath) throws Exception {
<span class="fc" id="L78">    conf = loadConfigFile(configPath);</span>
<span class="fc" id="L79">    initGame(conf);</span>
    // Load the layout
<span class="fc" id="L81">    String layoutFilename = conf.getString(&quot;layout&quot;);</span>
<span class="fc" id="L82">    loadLevel(layoutFilename);</span>
<span class="fc" id="L83">    mapValidityCheck();</span>
<span class="fc" id="L84">  }</span>

  /**
   * Initializes the game with the specified configuration.
   *
   * @param conf the configuration object.
   * @throws Exception if an error occurs during initialization.
   */
  public void initGame(JSONObject conf) throws Exception {
    // Load the timer settings
<span class="fc" id="L94">    JSONObject timeControls = conf.getJSONObject(&quot;time_controls&quot;);</span>
<span class="fc" id="L95">    JSONObject playerTimeControl = timeControls.getJSONObject(&quot;player&quot;);</span>
<span class="fc" id="L96">    JSONObject cpuTimeControl = timeControls.getJSONObject(&quot;cpu&quot;);</span>
<span class="fc" id="L97">    int playerSeconds = playerTimeControl.getInt(&quot;seconds&quot;);</span>
<span class="fc" id="L98">    int playerIncrement = playerTimeControl.getInt(&quot;increment&quot;);</span>
<span class="fc" id="L99">    int cpuSeconds = cpuTimeControl.getInt(&quot;seconds&quot;);</span>
<span class="fc" id="L100">    int cpuIncrement = cpuTimeControl.getInt(&quot;increment&quot;);</span>

    // Load the board settings
<span class="fc" id="L103">    String playerColour = conf.getString(&quot;player_colour&quot;);</span>
<span class="fc" id="L104">    int pieceMovementSpeed = conf.getInt(&quot;piece_movement_speed&quot;);</span>
<span class="fc" id="L105">    int maxMovementTime = conf.getInt(&quot;max_movement_time&quot;);</span>
<span class="fc" id="L106">    game =</span>
      new Game(
<span class="fc" id="L108">        playerColour.equals(&quot;white&quot;),</span>
        playerSeconds,
        cpuSeconds,
        playerIncrement,
        cpuIncrement,
        pieceMovementSpeed,
        maxMovementTime
      );
<span class="fc" id="L116">  }</span>

  /**
   * Handles the selection of a piece on the board.
   *
   * @param tile the selected tile.
   */
  public void handlePieceSelection(Tile tile) {
<span class="fc" id="L124">    Human human = game.getHumanAgent();</span>
    // get safe movements
<span class="fc" id="L126">    Set&lt;Movement&gt; safe = game.getSafeMovements(</span>
<span class="fc" id="L127">      game.getAllLegalMovements(human)</span>
    );
    // Must select a player's own piece first
<span class="fc" id="L130">    Piece piece = tile.getCurrentPiece();</span>
<span class="pc bpc" id="L131" title="2 of 4 branches missed.">    if (piece == null || piece.getColor() != human.getColor()) return;</span>
<span class="fc bfc" id="L132" title="All 2 branches covered.">    if (game.getInCheck() != null) {</span>
<span class="fc" id="L133">      boolean protective = false;</span>
<span class="fc bfc" id="L134" title="All 2 branches covered.">      for (Movement m : safe) {</span>
<span class="fc bfc" id="L135" title="All 2 branches covered.">        if (m.getSourcePiece() == piece) {</span>
<span class="fc" id="L136">          protective = true;</span>
<span class="fc" id="L137">          break;</span>
        }
<span class="fc" id="L139">      }</span>
<span class="fc bfc" id="L140" title="All 2 branches covered.">      if (!protective) {</span>
<span class="fc" id="L141">        game.setWarning(new KingProtectionWarning());</span>
<span class="fc" id="L142">        SoundPlayer.playSound(&quot;bruh.wav&quot;);</span>
<span class="fc" id="L143">        return;</span>
      }
    }
<span class="fc" id="L146">    human.select(tile);</span>
<span class="fc" id="L147">  }</span>

  /**
   * Handles the movement of a piece on the board.
   *
   * @param tile the target tile for the movement.
   */
  public void handlePieceMovement(Tile tile) {
<span class="fc" id="L155">    Human human = game.getHumanAgent();</span>
<span class="fc" id="L156">    Set&lt;Movement&gt; safe = game.getSafeMovements(</span>
<span class="fc" id="L157">      game.getAllLegalMovements(human)</span>
    );
    try {
<span class="pc bpc" id="L160" title="1 of 2 branches missed.">      if (tile == human.getSelection()) {</span>
        // Unselect
<span class="nc" id="L162">        throw new InvalidMoveException(human);</span>
<span class="fc" id="L163">      } else if (</span>
<span class="pc bpc" id="L164" title="1 of 2 branches missed.">        tile.getCurrentPiece() != null &amp;&amp;</span>
<span class="nc bnc" id="L165" title="All 2 branches missed.">        tile.getCurrentPiece().getColor() == human.getColor()</span>
      ) {
        // The player selects one of their other pieces
<span class="nc" id="L168">        human.select(tile);</span>
      } else {
<span class="fc" id="L170">        Piece selectedPiece = human.getSelection().getCurrentPiece();</span>
<span class="fc" id="L171">        Movement todo = new Movement(selectedPiece, tile);</span>
        // Invalid move
<span class="fc" id="L173">        boolean validity = false;</span>
<span class="fc bfc" id="L174" title="All 2 branches covered.">        for (Movement safeMovement : safe) {</span>
<span class="fc bfc" id="L175" title="All 2 branches covered.">          if (safeMovement.equals(todo)) validity = true;</span>
<span class="fc" id="L176">        }</span>
<span class="pc bpc" id="L177" title="1 of 2 branches missed.">        if (!validity) {</span>
<span class="nc" id="L178">          throw new InvalidMoveException(human);</span>
        }
        // Perform movement
<span class="fc bfc" id="L181" title="All 2 branches covered.">        if (</span>
          selectedPiece instanceof King &amp;&amp;
<span class="pc bpc" id="L183" title="1 of 2 branches missed.">          game.getDangerTiles(selectedPiece).contains(tile)</span>
        ) {
<span class="nc" id="L185">          throw new InvalidMoveException(human);</span>
        }
<span class="fc" id="L187">        game.movePiece(todo);</span>
      }
<span class="nc" id="L189">    } catch (InvalidMoveException err) {</span>
<span class="nc" id="L190">      System.out.println(&quot;Invalid move&quot;);</span>
<span class="nc" id="L191">    } catch (RuleViolationException err) {</span>
<span class="nc" id="L192">      System.out.println(err.getMessage());</span>
    } finally {
<span class="fc" id="L194">      human.clearSelection();</span>
    }
<span class="fc" id="L196">  }</span>

  /**
   * Determines the text to be displayed at the end of the game.
   *
   * @param endReason the reason for the game ending.
   * @return the end game text.
   */
  public String determineEndGameText(GameReport.EndReason endReason) {
<span class="nc bnc" id="L205" title="All 6 branches missed.">    switch (endReason) {</span>
      case COMPUTER_CHECKMATED:
<span class="nc" id="L207">        return &quot;You won by \ncheckmate!&quot;;</span>
      case COMPUTER_TIMEOUT:
<span class="nc" id="L209">        return &quot;You won on \ntime!&quot;;</span>
      case PLAYER_CHECKMATED:
<span class="nc" id="L211">        return &quot;You lost by \ncheckmate!&quot;;</span>
      case PLAYER_TIMEOUT:
<span class="nc" id="L213">        return &quot;You lost on time!&quot;;</span>
      case PLAYER_RESIGNED:
<span class="nc" id="L215">        return &quot;You resigned!&quot;;</span>
      default:
<span class="nc" id="L217">        return &quot;&quot;;</span>
    }
  }

  /**
   * Retrieves the list of image files from the specified image folder URL.
   *
   * @param imageFolder the URL of the image folder.
   * @return the list of image files.
   */
  public List&lt;File&gt; getImageFiles(URL imageFolder) {
<span class="nc" id="L228">    List&lt;File&gt; imageFiles = new ArrayList&lt;File&gt;();</span>
<span class="nc" id="L229">    File dir = new File(imageFolder.getPath());</span>
<span class="nc" id="L230">    File[] files = dir.listFiles();</span>
    // Ensure that files were found in the directory
<span class="nc bnc" id="L232" title="All 2 branches missed.">    if (files != null) {</span>
<span class="nc bnc" id="L233" title="All 2 branches missed.">      for (File file : files) {</span>
        // Only process .png files
<span class="nc bnc" id="L235" title="All 4 branches missed.">        if (file.isFile() &amp;&amp; file.getName().endsWith(&quot;.png&quot;)) {</span>
<span class="nc" id="L236">          imageFiles.add(file);</span>
        }
      }
    }
<span class="nc" id="L240">    return imageFiles;</span>
  }

  /**
   * Loads a chess level from a file.
   *
   * @param layoutFilename the name of the file containing the level layout.
   * @throws Exception if an error occurs during loading.
   */
  public void loadLevel(String layoutFilename) throws Exception {
<span class="fc" id="L250">    Scanner sc = null;</span>
<span class="fc" id="L251">    File layout = new File(layoutFilename);</span>
    try {
<span class="fc" id="L253">      sc = new Scanner(layout);</span>
<span class="fc" id="L254">      int x = 0, y = 0;</span>
      // The layout file will contain a grid of text characters, where each character represents the piece that should be in that cell.
<span class="fc bfc" id="L256" title="All 2 branches covered.">      while (sc.hasNextLine()) {</span>
<span class="fc" id="L257">        String row = sc.nextLine();</span>
<span class="fc bfc" id="L258" title="All 2 branches covered.">        for (Character c : row.toCharArray()) {</span>
          // Create a new piece based on the character from the layout file
<span class="fc" id="L260">          Piece cur = Piece.createPiece(c);</span>
<span class="pc bpc" id="L261" title="1 of 4 branches missed.">          if (c == ' ' || c == '.') {</span>
<span class="fc" id="L262">            x++;</span>
<span class="fc" id="L263">            continue;</span>
          }
<span class="pc bpc" id="L265" title="1 of 2 branches missed.">          if (cur == null) {</span>
<span class="nc" id="L266">            throw new InvalidObjectException(c.toString());</span>
          }
          // Get the appropriate agent for the piece based on its color
<span class="fc" id="L269">          PlayerAgent agent = game.getBoard().getAgentByColor(cur.getColor());</span>
          // Get the tile corresponding to the current position
<span class="fc" id="L271">          Tile parentTile = game.getTile(x, y);</span>
<span class="pc bpc" id="L272" title="1 of 2 branches missed.">          if (parentTile == null) {</span>
<span class="nc" id="L273">            throw new ArrayIndexOutOfBoundsException();</span>
          }
          // Set the current tile and piece
<span class="fc" id="L276">          cur.setCurrentTile(parentTile);</span>
<span class="fc" id="L277">          parentTile.setCurrentPiece(cur);</span>
          // Add the piece to the agent's list of pieces
<span class="fc" id="L279">          agent.getPieces().add(cur);</span>
          // If the piece is a king, set it as the agent's king
<span class="fc bfc" id="L281" title="All 2 branches covered.">          if (cur instanceof King) {</span>
<span class="pc bpc" id="L282" title="1 of 2 branches missed.">            if (agent.getKing() == null) {</span>
<span class="fc" id="L283">              agent.setKing((King) cur);</span>
            } else {
<span class="nc" id="L285">              throw new Exception(&quot;A player must not have more than one king.&quot;);</span>
            }
          }
<span class="fc" id="L288">          x++;</span>
        }
<span class="fc" id="L290">        y++;</span>
<span class="fc" id="L291">        x = 0;</span>
<span class="fc" id="L292">      }</span>
      // Refresh the available moves for the game
<span class="fc" id="L294">      game.refreshAvailableMoves(game.getBoard());</span>
<span class="nc" id="L295">    } catch (ArrayIndexOutOfBoundsException e) {</span>
<span class="nc" id="L296">      throw new Exception(&quot;The map must have the size of 14*14.&quot;);</span>
<span class="nc" id="L297">    } catch (InvalidObjectException e) {</span>
<span class="nc" id="L298">      throw new Exception(</span>
<span class="nc" id="L299">        &quot;Unexpected piece character '&quot; + e.getMessage() + &quot;'&quot;</span>
      );
<span class="fc" id="L301">    } catch (FileNotFoundException e) {</span>
<span class="fc" id="L302">      throw new Exception(&quot;File '&quot; + layoutFilename + &quot;' not found&quot;);</span>
    } finally {
<span class="fc bfc" id="L304" title="All 2 branches covered.">      if (sc != null) sc.close();</span>
    }
<span class="fc" id="L306">  }</span>

  /**
   * Checks the validity of the map.
   * Both kings must be present and the second player must not be checkmated initially.
   *
   * @throws Exception if the map is invalid.
   */
  public void mapValidityCheck() throws Exception {
    // Both kings MUST be present
<span class="pc bpc" id="L316" title="1 of 2 branches missed.">    if (game.getHumanAgent().getKing() == null) {</span>
<span class="nc" id="L317">      throw new Exception(</span>
        &quot;Unable to find human king in the map. Fix the map and try again.&quot;
      );
<span class="pc bpc" id="L320" title="1 of 2 branches missed.">    } else if (game.getBotAgent().getKing() == null) {</span>
<span class="nc" id="L321">      throw new Exception(</span>
        &quot;Unable to find computer king in the map. Fix the map and try again.&quot;
      );
    }
    // The second player MUST not be checkmated initially
    // TODO: Add a check for this condition
<span class="fc" id="L327">  }</span>

  /**
   * Determines the background color of a tile based on its current status.
   *
   * @param t the tile whose color is to be determined.
   * @return the color of the tile as an integer.
   */
  public int getTileBackgroundColor(Tile t) {
<span class="nc" id="L336">    Human human = game.getHumanAgent();</span>
    // Check if the king is in check
<span class="nc" id="L338">    InCheckIncident incheck = game.getInCheck();</span>
<span class="nc bnc" id="L339" title="All 4 branches missed.">    if (incheck != null &amp;&amp; t == incheck.getThreatenedKing().getCurrentTile()) {</span>
<span class="nc" id="L340">      KingProtectionWarning warning = game.getWarning();</span>
      // If the king is threatened and either there is no warning or the warning light is red, mark the tile as red
<span class="nc bnc" id="L342" title="All 4 branches missed.">      if (warning == null || warning.isRedLight()) {</span>
<span class="nc" id="L343">        return TileColor.TILE_RED;</span>
      }
    }
    // Highlight the current selection by marking it green
<span class="nc bnc" id="L347" title="All 2 branches missed.">    if (human.getSelection() == t) {</span>
<span class="nc" id="L348">      return TileColor.TILE_GREEN;</span>
    }
    // For other tiles, return the color based on the position of the tile on the board
<span class="nc bnc" id="L351" title="All 2 branches missed.">    if ((t.getX() + t.getY()) % 2 == 0) {</span>
<span class="nc" id="L352">      return TileColor.TILE_LIGHT;</span>
    } else {
<span class="nc" id="L354">      return TileColor.TILE_DARK;</span>
    }
  }

  /**
   * Class containing color definitions for different tile states.
   */
<span class="nc" id="L361">  public static class TileColor {</span>
    public static final int TILE_DARK = -4880285;
    public static final int TILE_LIGHT = -992843;
    public static final int TILE_GREEN = -9860532;
    public static final int TILE_BLUE = -5320224;
    public static final int TILE_RED = -3014397;
    public static final int TILE_CURRENT_SELECTION = -5857993;
    public static final int TILE_ENEMY_LAST_MOVE = -5463747;
    public static final int TILE_ORANGE = -159148;
  }

  // GUI Part (not unit-testable)

  /**
   * Initialise the setting of the window size.
   */
  @Override
  public void settings() {
<span class="nc" id="L379">    size(WIDTH, HEIGHT);</span>
<span class="nc" id="L380">  }</span>

  /**
   * Handle mouse press events.
   */
  @Override
  public void mousePressed(MouseEvent e) {
<span class="nc bnc" id="L387" title="All 2 branches missed.">    if (errorMessage != null) return;</span>
<span class="nc bnc" id="L388" title="All 2 branches missed.">    if (game.getGameStatus() != GameStatus.PLAYER_TURN) return;</span>

    // Get mouse position
<span class="nc" id="L391">    int mouseX = e.getX();</span>
<span class="nc" id="L392">    int mouseY = e.getY();</span>

    // Ignore invalid click events
<span class="nc bnc" id="L395" title="All 2 branches missed.">    if (mouseX &gt; WIDTH - SIDEBAR) return;</span>

    // Get the corresponding tile position
<span class="nc" id="L398">    int x = mouseX / Tile.CELLSIZE;</span>
<span class="nc" id="L399">    int y = mouseY / Tile.CELLSIZE;</span>

<span class="nc" id="L401">    System.out.println(&quot;x: &quot; + x + &quot; y: &quot; + y);</span>

    // Get the corresponding tile
<span class="nc" id="L404">    Tile tile = game.getTile(x, y);</span>

    // Check if it's the human's turn
<span class="nc" id="L407">    Human human = game.getHumanAgent();</span>

<span class="nc bnc" id="L409" title="All 2 branches missed.">    if (game.getCurrentPlayer() != human) return;</span>

    // Handle piece selection
<span class="nc bnc" id="L412" title="All 2 branches missed.">    if (human.isPending()) {</span>
<span class="nc" id="L413">      handlePieceSelection(tile);</span>
    }
    // Handle piece movement
    else {
<span class="nc" id="L417">      handlePieceMovement(tile);</span>
    }
<span class="nc" id="L419">  }</span>

  /**
   * Render the game state.
   */
  public void draw() {
<span class="nc" id="L425">    background(200);</span>
<span class="nc bnc" id="L426" title="All 2 branches missed.">    if (errorMessage != null) {</span>
<span class="nc" id="L427">      displayErrorMessage();</span>
<span class="nc" id="L428">      return;</span>
    }

<span class="nc" id="L431">    noStroke();</span>
<span class="nc bnc" id="L432" title="All 2 branches missed.">    if (game.getGameStatus() == GameStatus.ENDED) {</span>
<span class="nc" id="L433">      displayEndGameStatus();</span>
<span class="nc bnc" id="L434" title="All 2 branches missed.">    } else if (game.isEnded()) {</span>
<span class="nc" id="L435">      determineTimeoutEndReason();</span>
    } else {
<span class="nc" id="L437">      game.tick();</span>
<span class="nc" id="L438">      handleInCheckState();</span>
    }

<span class="nc" id="L441">    Set&lt;Tile&gt; targetTiles = getTargetTiles();</span>

    // Draw the tiles and pieces
<span class="nc bnc" id="L444" title="All 2 branches missed.">    for (int i = 0; i &lt; Board.BOARD_WIDTH; i++) {</span>
<span class="nc bnc" id="L445" title="All 2 branches missed.">      for (int j = 0; j &lt; Board.BOARD_WIDTH; j++) {</span>
<span class="nc" id="L446">        drawTile(i, j, targetTiles);</span>
      }
    }
<span class="nc" id="L449">    drawMovingPiece(game.getAnimation());</span>
<span class="nc" id="L450">    drawMovingPiece(game.getRookAnimation());</span>
<span class="nc" id="L451">    displayTimers();</span>
<span class="nc" id="L452">  }</span>

  /**
   * Displays an error message on the screen.
   */
  private void displayErrorMessage() {
<span class="nc" id="L458">    textSize(16);</span>
<span class="nc" id="L459">    fill(255, 10, 10);</span>
<span class="nc" id="L460">    textAlign(CENTER);</span>
<span class="nc" id="L461">    text(&quot;ERROR: &quot; + errorMessage, WIDTH / 2, HEIGHT / 2);</span>
<span class="nc" id="L462">  }</span>

  /**
   * Displays the end game status and instructions.
   */
  private void displayEndGameStatus() {
    // Display end game status and instructions
<span class="nc" id="L469">    GameReport report = game.getReport();</span>
<span class="nc" id="L470">    String endGameText = determineEndGameText(report.getReasonForEnd());</span>
<span class="nc" id="L471">    textSize(12);</span>
<span class="nc" id="L472">    textAlign(LEFT, BOTTOM);</span>
<span class="nc" id="L473">    text(endGameText, WIDTH - SIDEBAR + 10, HEIGHT / 2 - 10);</span>
<span class="nc" id="L474">    textAlign(LEFT, TOP);</span>
<span class="nc" id="L475">    text(</span>
      &quot;Press 'r' to\nrestart the game&quot;,
      WIDTH - SIDEBAR + 10,
      HEIGHT / 2 + 10
    );
<span class="nc" id="L480">  }</span>

  /**
   * Handles key press events.
   */
  @Override
  public void keyPressed() {
<span class="nc bnc" id="L487" title="All 2 branches missed.">    if (errorMessage != null) return;</span>
<span class="nc bnc" id="L488" title="All 3 branches missed.">    switch (key) {</span>
      case 'e': // ESC
<span class="nc bnc" id="L490" title="All 2 branches missed.">        if (game.getGameStatus() != GameStatus.ENDED) game.setReport(</span>
          new GameReport(game, EndReason.PLAYER_RESIGNED)
        );
        break;
      case 'r': // r
<span class="nc bnc" id="L495" title="All 2 branches missed.">        if (game.getGameStatus() == GameStatus.ENDED) setup();</span>
        break;
    }
<span class="nc" id="L498">  }</span>

  /**
   * Handles the in check state of the game.
   */
  private void handleInCheckState() {
<span class="nc bnc" id="L504" title="All 2 branches missed.">    if (game.getInCheck() != null) {</span>
<span class="nc bnc" id="L505" title="All 2 branches missed.">      if (game.getWarning() != null) {</span>
<span class="nc" id="L506">        textSize(12);</span>
<span class="nc" id="L507">        textAlign(LEFT, BOTTOM);</span>
<span class="nc" id="L508">        text(</span>
          &quot;You must protect\nyour king!&quot;,
          WIDTH - SIDEBAR + 10,
          HEIGHT / 2 - 10
        );
      } else {
<span class="nc" id="L514">        textSize(28);</span>
<span class="nc" id="L515">        textAlign(CENTER);</span>
<span class="nc" id="L516">        text(&quot;Check!&quot;, WIDTH - SIDEBAR / 2, HEIGHT / 2);</span>
      }
    }
<span class="nc" id="L519">  }</span>

  /**
   * Draws a tile on the screen.
   *
   * @param i           the x-coordinate of the tile.
   * @param j           the y-coordinate of the tile.
   * @param targetTiles the set of target tiles for possible moves.
   */
  private void drawTile(int i, int j, Set&lt;Tile&gt; targetTiles) {
<span class="nc" id="L529">    Tile t = game.getTile(i, j);</span>
<span class="nc" id="L530">    fill(getTileBackgroundColor(t));</span>
<span class="nc" id="L531">    rect(t.getLeft(), t.getTop(), Tile.CELLSIZE, Tile.CELLSIZE);</span>

<span class="nc" id="L533">    handleLastMoveHighlighting(t);</span>
<span class="nc" id="L534">    handlePossibleMoveHighlighting(t, targetTiles);</span>
<span class="nc" id="L535">    drawPieceOnTile(t);</span>
<span class="nc" id="L536">  }</span>

  /**
   * Handles highlighting of the last move on a tile.
   *
   * @param t the tile to be checked.
   */
  private void handleLastMoveHighlighting(Tile t) {
<span class="nc" id="L544">    PlayerAgent opponent = game.getCurrentPlayer().getOpponent();</span>
<span class="nc" id="L545">    if (</span>
<span class="nc bnc" id="L546" title="All 4 branches missed.">      opponent.getLastMoveSource() == t || opponent.getLastMoveTarget() == t</span>
    ) {
      // a tile which has a capturable enemy piece
<span class="nc" id="L549">      fill(TileColor.TILE_ENEMY_LAST_MOVE, 100);</span>
<span class="nc" id="L550">      rect(t.getLeft(), t.getTop(), Tile.CELLSIZE, Tile.CELLSIZE);</span>
    }
<span class="nc" id="L552">  }</span>

  /**
   * Handles highlighting of possible moves on a tile.
   *
   * @param t           the tile to be checked.
   * @param targetTiles the set of target tiles for possible moves.
   */
  private void handlePossibleMoveHighlighting(Tile t, Set&lt;Tile&gt; targetTiles) {
    // highlight all possible moves (excluding tiles of capturable pieces)
<span class="nc bnc" id="L562" title="All 4 branches missed.">    if (targetTiles != null &amp;&amp; targetTiles.contains(t)) {</span>
<span class="nc" id="L563">      highlightValidMoves(t);</span>
    }
<span class="nc" id="L565">  }</span>

  /**
   * Highlights valid moves on a tile.
   *
   * @param t the tile to be highlighted.
   */
  private void highlightValidMoves(Tile t) {
<span class="nc bnc" id="L573" title="All 2 branches missed.">    if (t.getCurrentPiece() == null) {</span>
<span class="nc" id="L574">      fill(TileColor.TILE_BLUE, 200);</span>
<span class="nc" id="L575">      rect(t.getLeft(), t.getTop(), Tile.CELLSIZE, Tile.CELLSIZE);</span>
<span class="nc" id="L576">    } else if (</span>
<span class="nc bnc" id="L577" title="All 2 branches missed.">      t.getCurrentPiece().getColor() != game.getHumanAgent().getColor()</span>
    ) {
      // highlight capturable pieces
<span class="nc" id="L580">      if (</span>
<span class="nc bnc" id="L581" title="All 2 branches missed.">        game.getHumanAgent().getAllTargetTiles() != null &amp;&amp;</span>
<span class="nc bnc" id="L582" title="All 2 branches missed.">        game.getHumanAgent().getAllTargetTiles().contains(t)</span>
      ) {
<span class="nc" id="L584">        fill(TileColor.TILE_ORANGE, 255);</span>
<span class="nc" id="L585">        rect(t.getLeft(), t.getTop(), Tile.CELLSIZE, Tile.CELLSIZE);</span>
      }
    }
<span class="nc" id="L588">  }</span>

  /**
   * Draws a piece on a tile.
   *
   * @param t the tile to draw the piece on.
   */
  private void drawPieceOnTile(Tile t) {
<span class="nc" id="L596">    Piece p = t.getCurrentPiece();</span>
<span class="nc bnc" id="L597" title="All 2 branches missed.">    if (p != null) {</span>
<span class="nc" id="L598">      if (</span>
<span class="nc bnc" id="L599" title="All 4 branches missed.">        game.getAnimation() != null &amp;&amp; p == game.getAnimation().getMovingPiece()</span>
<span class="nc" id="L600">      ) return; // I will draw you later!</span>
<span class="nc" id="L601">      if (</span>
<span class="nc bnc" id="L602" title="All 2 branches missed.">        game.getRookAnimation() != null &amp;&amp;</span>
<span class="nc bnc" id="L603" title="All 2 branches missed.">        p == game.getRookAnimation().getMovingPiece()</span>
<span class="nc" id="L604">      ) return; // I will draw you later too!</span>
<span class="nc" id="L605">      image(p.getImage(), p.getLeft(), p.getTop());</span>
    }
<span class="nc" id="L607">  }</span>

  /**
   * Draws a moving piece on the screen.
   *
   * @param animation the animation representing the moving piece.
   */
  private void drawMovingPiece(AnimationVehicle animation) {
<span class="nc bnc" id="L615" title="All 2 branches missed.">    if (animation != null) {</span>
<span class="nc" id="L616">      PImage afterimage = animation.getAfterimage();</span>
<span class="nc bnc" id="L617" title="All 2 branches missed.">      if (afterimage != null) {</span>
<span class="nc" id="L618">        image(</span>
          afterimage,
<span class="nc" id="L620">          (float) animation.getTargetLeft(),</span>
<span class="nc" id="L621">          (float) animation.getTargetTop()</span>
        );
      }
<span class="nc" id="L624">      Piece movingPiece = animation.getMovingPiece();</span>
<span class="nc" id="L625">      image(</span>
<span class="nc" id="L626">        movingPiece.getImage(),</span>
<span class="nc" id="L627">        (float) animation.getLeft(),</span>
<span class="nc" id="L628">        (float) animation.getTop()</span>
      );
    }
<span class="nc" id="L631">  }</span>

  /**
   * Displays the timers for the game.
   */
  private void displayTimers() {
<span class="nc" id="L637">    textSize(24);</span>
<span class="nc" id="L638">    fill(color(255, 255, 255));</span>
<span class="nc" id="L639">    textAlign(CENTER);</span>
    // display the computer timer
<span class="nc" id="L641">    int left = WIDTH - SIDEBAR / 2;</span>
<span class="nc" id="L642">    text(Utils.formatSeconds(game.getBotAgent().getRemainingTime()), left, 50);</span>
    // display the player timer
<span class="nc" id="L644">    text(</span>
<span class="nc" id="L645">      Utils.formatSeconds(game.getHumanAgent().getRemainingTime()),</span>
      left,
      HEIGHT - 50
    );
<span class="nc" id="L649">  }</span>

  /**
   * Initializes the application by loading the configuration and images.
   */
  @Override
  public void setup() {
<span class="nc" id="L656">    frameRate(FPS);</span>
    // Load configuration using the simple JSON library
    try {
<span class="nc" id="L659">      loadXXLChess(configPath);</span>
      // Load images
<span class="nc" id="L661">      preloadPieceImages();</span>
<span class="nc" id="L662">    } catch (Exception e) {</span>
<span class="nc" id="L663">      errorMessage = e.getMessage();</span>
<span class="nc" id="L664">    }</span>
<span class="nc" id="L665">  }</span>

  /**
   * Handles the main entry point for the application.
   *
   * @param args the command line arguments.
   */
  public static void main(String[] args) {
    // Launch the application
<span class="nc" id="L674">    PApplet.main(&quot;XXLChess.App&quot;);</span>
<span class="nc" id="L675">  }</span>

  /**
   * Loads the configuration file.
   *
   * @param configPath the path to the configuration file.
   * @return the loaded JSON configuration object.
   * @throws Exception if the configuration file cannot be found or loaded.
   */
  public static JSONObject loadConfigFile(String configPath) throws Exception {
<span class="fc" id="L685">    File configFile = new File(configPath);</span>
<span class="pc bpc" id="L686" title="1 of 2 branches missed.">    if (!configFile.exists()) {</span>
<span class="nc" id="L687">      throw new Exception(&quot;Could not find the config file&quot;);</span>
    }
<span class="fc" id="L689">    return loadJSONObject(configFile);</span>
  }

  /**
   * Preloads the images for the chess pieces from the resources directory.
   */
  public void preloadPieceImages() {
<span class="nc" id="L696">    URL imageFolder = App.class.getClassLoader().getResource(&quot;XXLChess/images&quot;);</span>
<span class="nc bnc" id="L697" title="All 2 branches missed.">    for (File file : getImageFiles(imageFolder)) {</span>
<span class="nc" id="L698">      PImage img = loadImage(imageFolder.getPath() + &quot;/&quot; + file.getName());</span>
<span class="nc" id="L699">      img.resize(Tile.CELLSIZE, Tile.CELLSIZE);</span>
<span class="nc" id="L700">      Piece.imageSources.put(file.getName(), img);</span>
<span class="nc" id="L701">    }</span>
<span class="nc" id="L702">  }</span>

  private void determineTimeoutEndReason() {
<span class="nc" id="L705">    game.setReport(</span>
      new GameReport(
        game,
<span class="nc bnc" id="L708" title="All 2 branches missed.">        game.getHumanAgent().isEnded()</span>
          ? GameReport.EndReason.PLAYER_TIMEOUT
          : GameReport.EndReason.COMPUTER_TIMEOUT
      )
    );
<span class="nc" id="L713">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>